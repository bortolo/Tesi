\chapter{Resolution of the system}

\section{Iteration algorithms}

The high nonlinear nature of the problem 	makes an analytical treatment very difficult, if not even impossible. For this reason, numerical schemes must be used to compute an approximate solution of the system \referenzaeq{eq: stationary problem}. Indisputably, the most used algorithms are \textit{the fully coupled Newton's method} and \textit{the decoupled Gummel map}. We spent only few words on the former as we implemented the latter, but first of all let us introduce a suitable linearization of the stationary DD equations. We can consider \referenzaeq{eq: stationary problem} in a more compact form as:

\begin{equation}
\label{eq: abstract problem fully}
\vect{F(U)}=\vect{0}
\end{equation}

where:

\begin{equation}
\vect{U}:=[\varphi,n,p]^T \psp{30} \vect{F(U)}:=\left[ \begin{array}{c}
F_1(\vect{U}) \\
F_2(\vect{U}) \\
F_3(\vect{U})
\end{array}
\right]
\end{equation}

and having set:

\begin{align*}
F_1(\vect{U}) & = \nabla \cdot (-\epsilon \nabla \varphi) - q(p-n+N_D^+-N_A^-) \\
F_2(\vect{U}) & = \nabla \cdot ( - q\mu_n n \nabla \varphi + qD_n \nabla n )-qR \\
F_3(\vect{U}) & = \nabla \cdot (- q\mu_p p \nabla \varphi - qD_p \nabla p )+qR
\end{align*}

\vspace{0.1cm}

Basically the fully coupled Newton's method is an extension to differential operators of the well known Newton's method for the search of a zero for real functions ($f:\mathbb{R}\rightarrow \mathbb{R}$). In fact the vector function $\vect{F}$ is a nonlinear differential operator and the associated problem which we intend to resolve is given a functional space $V$ and the operator $\vect{F}:V\rightarrow V$, find $\vect{U}\in V$ such that \referenzaeq{eq: abstract problem fully} is satisfied.
Just for the moment we don't care about the identity of $V$, which we will treat in details in the next section; now we are able to define  the abstract Newton's Method for the iterative solution of problem \referenzaeq{eq: stationary problem}:

\mybox{
\vspace{0.1cm}
Given $\vect{U}^0\in V$, for all $k\geq 0$ until convergence, solve the following linearized problem: 

\begin{equation}
\label{eq: abstract newton's method}
\begin{array}{c}
\vect{F'}(\vect{U}^k)\delta\vect{U}^k=-\vect{F}(\vect{U}^k) \\
\vect{U}^{k+1} = \vect{U}^k + \delta \vect{U}^k
\end{array}
\end{equation}
where $\vect{F'}$ is the Jacobian matrix of $\vect{F}$, whose $(i,j)$-th entry represents the Frech\`et derivative of the $i$-th row with respect to the $j$-th variable.
}{\textbf{Fully Coupled Newton's Method}}

\vspace{0.1cm}

The main advantage of this approach is without doubt the existence of the sequent theorem:

\begin{Teorema}
\label{theorem: newton convergence}
Let  $\vect{U}\in V$ be a solution of problem \referenzaeq{eq: abstract problem fully}. Assume that $\vect{F'}$ is Lipschitz continuos in the ball $\mathcal{B}(\vect{U},\delta)$, i.e., that there exists  $K>0$ such that:
\begin{equation}
||\vect{F'}(\vect{v})-\vect{F'}(\vect{z})||_{L(V,V)} \leq K ||\vect{v}-\vect{z}||_V \psp{10} \forall \vect{v},\vect{z} \in \mathcal{B}(\vect{U},\delta), \, \vect{v}\neq \vect{z}
\end{equation}
Then there exists in correspondence $\delta '>0$, with $\delta '\leq\delta$, such that for all $\vect{U}^0 \in \mathcal{B}(\vect{U},\delta ')$ the sequence $\left\{ \vect{U}^k \right\}$ generated by \referenzaeq{eq: abstract newton's method} converges quadratically to $\vect{U}$, i.e., there exists $C>0$ such that, for a suitable $k_0\geq 0$ we have:
\begin{equation}
\label{eq: convergece newton}
||\vect{U}-\vect{U}^{k+1}||_V\leq C||\vect{U}-\vect{U}^k||_V^2 \psp{15} \forall k\geq k_0
\end{equation}
\end{Teorema}

Even the presence of this impressive result there are are several issues which must be evaluated before move toward this way of resolution:
\begin{itemize}
\item the jacobian matrix $\vect{F'}$ is often quite ill-conditioned and needs appropriate scaling and balancing in order to avoid problems associated with round-off error;
\item to ensure convergence of the Newton iterative process \referenzaeq{eq: abstract newton's method}, it is particularly important to ensure a very good initial guess for the unknown variables $\vect{U}$;
\item if a direct solver is adopted (based on the LU factorization method), the number of loating point operations is of the order of  $N_{dofs}^3$, where $N_{dofs}$ is the number of degree of freedom used for the numerical approximation.
\end{itemize}

The fully coupled method is not the only possible approach, and many of the above points will be fixed adopting different methods, however theorem \referenzaeq{theorem: newton convergence} guarantees the best error convergence estimation.

\subsection{Gummel map algorithm}

In 1964 H. K. Gummel proposed an orginal iterative algorithm in order to solve the system \referenzaeq{eq: stationary problem} in a semiconductor device in one spatial dimension. Today the Gummel decoupled iterative algorithm has become a milestone in contemporary device simulation in industrial software for the design and analysis of semiconductor devices.

The main idea of the algorithm is to move the nonlinearity to the Poisson equation only and once obtained the electric potential profile, both continuity equations are linearized.  More precisely give an initial guess for $\varphi$, $n$ and $p$, the functional iteration consists in the succesive solution of the nonlinear Poisson's equation (NLP) in a inner loop (Newton's method is applyed for this equation) and of the two linearized continuity equations (DD electrons and DD holes). 
A concisely scheme is presented in \figref{fig: gummel map}.

Unfortunately there isn't any convergence result for this method like \referenzaeq{theorem: newton convergence}, although there are several advantages which make Gummel map algorithm preferable to the Fully Coupled Newton's Method.
In fact simulations experience shows that the Gummel process is much more insesitive to the choice of the initial guess than Newton's method. This is particularly important in multidimensional problems where it is far from trivial to design a good starting point for initializing in a favorable manner.

Another attractive feature is the reduced computational and memory stage cost: at each iteration step, the Newton algorithm requires assembling a Jacobian matrix of size $3N_{dof}\times 3N_{dof}$, while the Gummel algorithm requires the successive solution of three problems, each one of size equal to $N_{dof}\times N_{dof}$.

\subsubsection{FEMOS Gummel map}
After this short presentation of the qualities and the drawbacks of the Gummel decoupled algorithm, we propose our functional iteration. For the sake of simplicity let us consider some useful hypotesis:






\begin{figure}[!h]
\begin{center}
\begin{tikzpicture}
[scale=1.2]

\tikzstyle{NLP}=[rectangle,text width=3cm, align=center,draw, fill=gray!40];
\tikzstyle{DD}=[rectangle,text width=3cm,align=center,draw,fill=gray!10];
\tikzstyle{Normal}=[rectangle,fill=white];
\tikzstyle{CYC}=[diamond,draw];
\useasboundingbox (0,1) rectangle (8,9.5);
\draw [thick] (-0.5,1.0) rectangle (8.5,9.5);
%main boxes
\node [Normal] (v0) at (1,8) {$[\varphi,n,p]_{start}$};
\node [NLP] (v1) at (4,8) {\large NLP};
\node [CYC] (v2) at (4,7) {\small k};
\node [DD] (v3) at (4,5.5) {\large DD electrons};
\node [DD] (v4) at (4,4.0) {\large DD holes};
\node [CYC] (v5) at (4,2.5) {\small i};

%collegamenti
\draw [thick,->] (v0) -- (v1);
\draw [thick,->] (v1) -- (v2);
\draw [thick,->] (v2) -- (v3);
\draw [thick,->] (v3) -- (v4);
\draw [thick,->] (v4) -- (v5);
\draw [thick,->] (v5)--(7,2.5)--(7,9)--(4,9)--(v1);
\draw [thick,->] (v2)--(6,7)--(6,8)--(v1);
\draw [thick,->] (v5)--(4,1.5);

%note
\node [Normal] (v6) at (5.5,7.3) {$\varphi^{k+1}$};
\node [Normal] (v6) at (4.5,6.2) {$\varphi_{i+1}$};
\node [Normal] (v6) at (4.5,4.7) {$n_{i+1}$};
\node [Normal] (v6) at (4.5,3.2) {$p_{i+1}$};
\node [Normal] (v0) at (5.0,1.8) {$[\varphi,n,p]_{end}$};
\end{tikzpicture}
\caption{Gummel map algorithm}
\label{fig: gummel map}
\end{center}
\end{figure}


\begin{itemize}
\item we consider a polygonal simulation domain  in $\mathbb{R}^3$, denoted with $\Omega$; we indicate also with $\Omega_s$ the subset of $\Omega$ characterized by semiconductor material;
\item the domain is formed only by semiconductor and/or oxide material (typically we consider silicon and $SiO_2$);
\item contacts are assumed to be ideal, i.e. they are equipotential surfaces and no voltage drop occurs at the interface between the contact and the neighbouring material.
\end{itemize}
Take into account these considerations the appropriate Gummel map in our cases is the sequent:




\mybox{
Given $n^0$ and $p^0$, $\forall k$ until convergence:

\vspace{0.5cm}

(Step 0) Compute $\varphi_n^k$ and $\varphi_p^k$ with \referenzaeq{eq: n density mb} and \referenzaeq{eq: p density mb}.

\vspace{0.5cm}

(Step 1) Solve the nonlinear Poisson equation over all the domain (NLP):

{
\footnotesize
\[
\begin{cases}
\nabla \cdot (-\epsilon \nabla \varphi) + n_i\left( exp\left(\dfrac{\varphi-\varphi_n^{(k)}}{V_{th}}\right) - exp\left(\dfrac{\varphi_p^{(k)}-\varphi}{V_{th}}\right) \right)  =  q(N_D^+-N_A^-) & in \psp{3} \Omega_s \\
\nabla \cdot (-\epsilon \nabla \varphi)  =  0 & in \psp{3} \Omega / \Omega_s
\end{cases}
\]
}

Set $\varphi^k=\varphi$.

\vspace{0.5cm}

(Step 2) Solve the Linear Electron Contintuity Equation (LEC):
\begin{equation*}
 \nabla \cdot ( - q\mu_n n \nabla \varphi^{(k)} + qD_n \nabla n ) = qR(n^{k-1},p^{k-1}) \psp{8} in \psp{3} \Omega_s
\end{equation*}
Set $n^k=n$.

\vspace{0.5cm}

(Step 3) Solve the Linear Hole Contintuity Equation (LHC):
\begin{equation*}
\nabla \cdot (- q\mu_p p \nabla \varphi^{(k)} - qD_p \nabla p ) =  -qR(n^{k-1},p^{k-1}) \psp{8} in \psp{3} \Omega_s
\end{equation*}
Set $p^k=p$.

\vspace{0.5cm}

(Step 4) If the convergence criterion is satisfied break, otherwise restart from step 0.

}{\textbf{FEMOS Gummel Map}}


\textcolor{red}{Dobbiamo parlare delle slotboom variables e della possibilità di usare i quasi fermi?????}
It's interesting note that carrier densities are not the only useful variables. As we introduced in section \referenzaeq{subsub:driftdiffusion transport}, current density may be represented in many different ways.  We underlie this because for example one can solve system \referenzaeq{eq: stationary problem} with Slotboom variables, without any change in the structure of the Gummel map.


\section{Finite element discretization}

In this section we describe the finite element discretization of the differential subproblems involved in the Gummel map previously introduced. Moreover for each kind of PDE problem we give a briefly presentation of the well-posedness analysis. 


\input{contents/NonLinearPoisson}
%
%\subsection{Nonlinear Poisson Equation}
%Using the definition of the Frech\`et derivative one can calculated the Jacobian matrix, which in this case has $1\times 1$ dimensions. Note that the electrostatic problem must be resolved on the whole domain and the right hand side changes from region to region.
%
%\textcolor{blue}{Qui dipende da come vogliamo introdurre FEMOS...sarebbe carino far capire la scelta che è stata fatta di porre nei nodi di frontiera del silicio il valore della forzante e della reazione del silicio.Ma ovviamente questo discorso necessita una introduzione sui casi test.}
%
%\subsubsection{Weak formulation}
%Let us consider the linearized problem \textcolor{blue}{(qua ci vuole la referenza a quella linearizzata)} in a more generalized form which reads as follows:
%\begin{equation}
%\left\{
%\begin{array}{rcll}
%\nabla \cdot (-\epsilon \nabla \varphi) + \sigma^{(k)}(\vect{x}) \varphi & = &  f^{(k)}(\vect{x}) & \psp{15} in \psp{2} \Omega \\
%\varphi & = & \varphi_D & \psp{15} on \psp{2} \Gamma_D \\
%\nabla \varphi \cdot \vect{n} & = & 0 & \psp{15} on \psp{2} \Gamma_N
%\end{array}
%\right.
%\end{equation}
%
%For the sake of simplicity we summerize the reaction and force term in $\sigma$ and $f$, but we kept visible the iteration dependence.
%The well-posedness of such problem is ensured by several (and reasonable) hypotesis:
%\begin{itemize}
%\item $\epsilon \in L^{\infty}(\Omega)$ and $\exists m$ s.t. $0 < m \leq \epsilon$ (a.e.) in $\Omega$;
%\item  $\sigma \in L^{\infty}(\Omega)$ and $\exists m$ s.t. $0 < m \leq \sigma$ (a.e.) in $\Omega$.
%\end{itemize}
%
%We proceed with the classical displacement weak formulation.
%Given $\varphi_D \in H^{1/2}(\Gamma_D)$ and $f \in L^2(\Omega)$ find $\varphi \in H^1(\Omega)$ such that 
%
%\begin{equation}
%\int_{\Omega} \epsilon \nabla \varphi \nabla v \, d\Omega + \int_{\Omega} \sigma^{(k)}\varphi v \, d\Omega = \int_{\Omega} f^{(k)}v \, d\Omega \psp{15} \forall v \in H^1_{\Gamma_D}(\Omega)
%\end{equation}
%
%\subsubsection{Numerical approximation}
%
%\subsubsection{Damping}
%\textcolor{blue}{Interessante fare vedere qualche grafico con qualche controllo della convergenza...}
%
%
%
%\subsection{Drawbacks of the Box Methods}
%While the box method has become the standard technique for the discretization of the continuity equations, it suffers from several drawbacks arising from geometrical considerations. Satisfactory results can be obtained only for acute triangulations. Even one obtuse triangle can lead to a large spike in the solution of the equation.
%
%These considerations urges us to pursue an alternative approach: the decoupled Gummel Map.
%First of all we have to introduce the Maxwell-Boltzamann approximation for the carriers:
%\begin{equation}
%\begin{array}{rcl}
%n&=&n_iexp\left(\dfrac{\varphi-\varphi_n}{V_{th}}\right) \\
%p&=&n_iexp\left(\dfrac{\varphi_p-\varphi}{V_{th}} \right)\\
%\end{array}
%\end{equation} 
%Thanks to these expressions we are able to shift the nonlinearity on the poisson equation. Finally we obtain the following system:
%\begin{equation}
%\label{eq: gummel map system}
%\left\{
%\begin{array}{rcl}
%\nabla \cdot (-\epsilon \nabla \varphi) + n_i\left( exp\left(\dfrac{\varphi-\varphi_n}{V_{th}}\right) - exp\left(\dfrac{\varphi_p-\varphi}{V_{th}}\right) \right) & = & q(N_D^+-N_A^-) \\ \\
%-q\dfrac{\partial n}{\partial t} + \nabla \cdot ( - q\mu_n n \nabla \varphi + qD_n \nabla n )& = & qR\\ \\
%q\dfrac{\partial p}{\partial t} + \nabla \cdot (- q\mu_p p \nabla \varphi - qD_p \nabla p )& = & -qR
%\end{array}
%\right.
%\end{equation}
%
%Referring on system \referenzaeq{eq: gummel map system} it's trivial introduce the Gummel Map algorithm:
%\mybox{
%Given $\varphi_n^{(0)}$ and $\varphi_p^{(0)}$, $\forall k$ until convergence:
%\\
%\begin{itemize}
%\item Solve the Nonlinear Poisson Equation (NLP):
%\begin{equation*}
%\nabla \cdot (-\epsilon \nabla \varphi) + n_i\left( exp\left(\dfrac{\varphi-\varphi_n^{(k)}}{V_{th}}\right) - exp\left(\dfrac{\varphi_p^{(k)}-\varphi}{V_{th}}\right) \right)  =  q(N_D^+-N_A^-)
%\end{equation*}
%Set $\varphi^{(k)}=\varphi$.
%\\
%\item Solve the Linear Electron Contintuity Equation (LEC):
%\begin{equation*}
%-q\dfrac{\partial n}{\partial t} + \nabla \cdot ( - q\mu_n n \nabla \varphi^{(k)} + qD_n \nabla n ) = qR
%\end{equation*}
%Set $n^{(k)}=n$.
%\\
%\item Solve the Linear Hole Contintuity Equation (LHC):
%\begin{equation*}
%q\dfrac{\partial p}{\partial t} + \nabla \cdot (- q\mu_p p \nabla \varphi^{(k)} - qD_p \nabla p ) =  -qR
%\end{equation*}
%Set $p^{(k)}=p$.
%\end{itemize}
%
%}{Gummel Map}
%
%Actually there are several methods to set up this algorithm and basically they depends on how we represent the conduction current density. Take for example this well-known change of variables proposed by the physicist Jan Slotboom:
%\begin{equation}
%\label{eq: slotboom formulas}
%\begin{array}{rcl}
%u_n & := & n_i exp\left(-\dfrac{\varphi_n}{V_{th}} \right)\\
%u_p & := & n_i exp\left(\dfrac{\varphi_p}{V_{th}} \right) \\
%\end{array}
%\end{equation}
%As a consequence we can reformulate \referenzaeq{eq: full problem} taking into account this interesting series of equivalences:
%\begin{multline*}
%\footnotesize
%\vect{J_n}=
%q\mu_n \left( - n \nabla \varphi + V_{th} \nabla \left( u_n exp\left(\dfrac{\varphi}{V_{th}} \right) \right) \right) \\ = 
%q \mu_n \left(  -n \nabla \varphi + V_{th}\nabla u_n exp\left(\dfrac{\varphi}{V_{th}} \right) + n \nabla \varphi \right) \\ =
%q D_n exp\left(\dfrac{\varphi}{V_{th}} \right) \nabla u_n 
%\end{multline*}
%
%The new Gummel Map algorithm read as follows:
%
%\mybox{
%Given $u_n^{(0)}$ and $u_p^{(0)}$, $\forall k$ until convergence:
%\\
%\begin{itemize}
%\item Solve the Nonlinear Poisson Equation (NLP):
%\begin{equation*}
%\nabla \cdot (-\epsilon \nabla \varphi) + u_n^{(k)}exp\left(\dfrac{\varphi}{V_{th}}\right) - u_p^{(k)}exp\left(\dfrac{-\varphi}{V_{th}}\right) =  q(N_D^+-N_A^-)
%\end{equation*}
%Set $\varphi^{(k)}=\varphi$.
%\\
%\item Solve the Linear Electron Contintuity Equation (LEC):
%\begin{equation*}
%-q\dfrac{\partial u_nexp\left(\dfrac{\varphi^{(k)}}{V_{th}}\right)}{\partial t} + \nabla \cdot ( q D_n exp\left(\dfrac{\varphi^{(k)}}{V_{th}} \right) \nabla u_n ) = qR
%\end{equation*}
%Set $u_n^{(k)}=u_n$.
%\\
%\item Solve the Linear Hole Contintuity Equation (LHC):
%\begin{equation*}
%q\dfrac{\partial u_pexp\left(\dfrac{-\varphi^{(k)}}{V_{th}}\right)}{\partial t} + \nabla \cdot (q D_n exp\left(\dfrac{-\varphi}{V_{th}} \right) \nabla u_p ) =  -qR
%\end{equation*}
%Set $u_p^{(k)}=u_p$.
%\end{itemize}
%
%}{Gummel Map}





\subsection{Continuity Equation}


\subsubsection{Weak formulation}
Without loss of generality we consider only the electron continuity equation (similar reasoning could be make for the hole continuity equation). Problem \textcolor{blue}{referenza al problema} is a classical diffusion-advection-reaction (DAR) problem written in conservative form. We will treat this PDE's equation likewise Poisson equation with the standard displacement weak formulation.

Be carefull about the right hand side: in the operation of many devices this term generates mass; this implies that a new reaction term is usually added in the left side of the equation:
\begin{equation}
R_n = \sigma n - f
\end{equation}

\begin{equation}
\left\{
\begin{array}{rcll}
\dfrac{\partial n}{\partial t} + \nabla \cdot ( - D_n \nabla n ) + \nabla \cdot ( \mu_n \nabla \varphi^{(k)} n )  + \sigma n & = & f  & \psp{15} in \psp{2} \Omega \\
n & = &  n_D & \psp{15} on \psp{2} \Gamma_D \\
\nabla n \cdot \vect{n} & = & 0 & \psp{15} on \psp{2} \Gamma_N
\end{array}
\right.
\end{equation}

Given $n_D \in H^{1/2}(\Gamma_D)$ and $f \in L^2(\Omega)$ find $n \in H^1(\Omega)$ such that:

\begin{equation}
\left\{
\begin{array}{rcll}
\dfrac{\partial n}{\partial t} + \nabla \cdot ( - D_n \nabla n ) + \mu_n \nabla \varphi^{(k)} \nabla n  + (\mu_n \Delta \varphi^{(k)} + \sigma) n & = & f  & \psp{15} in \psp{2} \Omega \\
n & = &  n_D & \psp{15} on \psp{2} \Gamma_D \\
\nabla n \cdot \vect{n} & = & 0 & \psp{15} on \psp{2} \Gamma_N
\end{array}
\right.
\end{equation}

with $\Gamma_D\cap\Gamma_N=\varnothing$, $\Gamma_D\cup\Gamma_N=\partial \Omega$ and where $\vect{n}$ is the outward normal vector on $\Omega$.
We respect the standard hypotesti for the wellposdness of the problem:
\begin{itemize}
\item $D_n \in L^{\infty}(\Omega)$ and $\exists \, m$ s.t. $0<m\leq D_n$ a.e. in $\Omega$;
\item $\sigma \in L^{\infty}(\Omega)$ and $\exists \, m$ s.t. $0<m\leq \sigma$ a.e. in $\Omega$;
\item $\mu_n \nabla \varphi \in (W^{1,\infty}(\Omega))^d$.
\end{itemize}

\textcolor{blue}{formulazione con tempo?}


\subsubsection{Numerical approximation}
In view of the finite element discretization of problem, we let $\bar{\Omega} = \bigcup \bar{K}$ be a partition $\mathcal{T}_h$ of the domain into triangular elements $K$ of area $|K|$.
 We suppose that $\mathcal{T}_h$ satisfied the \textit{classical regularity condition}
  \citep{quarteroni:modnum} 
  
\textcolor{blue}{Partiamo con una semidiscretizzazione spaziale e poi trattiamo anche quella temporale?}

\textcolor{blue}{Descrizione dettagliata (o meno?) del metodo implementato FVSG}

\subsection{Maximum discrete principle}
\textcolor{blue}{Scriviamo qualcosa in merito?Quanto approfondito?}




